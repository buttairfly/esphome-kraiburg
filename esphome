#!/bin/bash

SCRIPT_DIR="$(dirname -- $(readlink -fn -- "$0"))"
ARGS=$@
source "${SCRIPT_DIR}/.env"

NONE='\e[0m'
RED='\e[31m'
GREEN='\e[32m'
YELLOW='\e[33m'
BLUE='\e[34m'

COMMANDS=('run' 'upload' 'rename')
for c in "${COMMANDS[@]}"; do
	if printf '%s\0' "$ARGS" | grep -Fxqz -- "$c"; then
        # check git status when calling one of $COMMANDS
        if GIT_STATUS=$(git status --porcelain) && [ -n "$GIT_STATUS" ]; then
            echo -e "You have ${YELLOW}uncommited changes${NONE}:"
            git status --short
            read -p $'Do you want to \e[34mproceed\e[0m? (\e[33myN\e[0m): ' YN
            case $YN in 
                y ) echo -e "${GREEN}Proceeding${NONE}...\n";;
                * ) echo -e "${RED}Aborted${NONE}";
                    exit 1;;
            esac
        fi
        # append version to config
        ARGS=( "-s" "version" "${GIT_VERSION}" ${ARGS[@]} )
        break
    fi
done

podman run --rm -v "${SCRIPT_DIR}":/config -it docker.io/esphome/esphome:"${ESPHOME_TAG}" "${ARGS[@]}"
